# File Commands

This document describes the file operation commands provided by the daemon. These commands enable secure file manipulation with path validation, atomic writes, and permission management.

> **Note:** All requests must use the `SignedRequest` format with `command`, `params`, `timestamp`, `nonce`, and `signature` fields. See [Wire Protocol](7-wire-protocol.md) for the complete format specification. Responses use `success`, `request_id`, and `data`/`error` fields.

## Table of Contents

- [Overview](#overview)
- [Path Validation](#path-validation)
  - [Allowed Path Prefixes](#allowed-path-prefixes)
  - [Protected Files](#protected-files)
  - [Path Traversal Protection](#path-traversal-protection)
  - [Symlink Protection](#symlink-protection)
- [Atomic Write Pattern](#atomic-write-pattern)
- [Commands](#commands)
  - [file.write](#filewrite)
  - [file.write_template](#filewrite_template)
  - [file.delete](#filedelete)
  - [file.mkdir](#filemkdir)
  - [file.chmod](#filechmod)

---

## Overview

The file commands module provides five commands for file manipulation:

| Command | Description |
|---------|-------------|
| `file.write` | Write content to a file |
| `file.write_template` | Render a template and write the result |
| `file.delete` | Delete a file |
| `file.mkdir` | Create a directory |
| `file.chmod` | Set file or directory permissions |

All file operations enforce strict path validation to prevent unauthorized access to system files.

---

## Path Validation

### Allowed Path Prefixes

File operations are restricted to paths that begin with one of the following prefixes:

| Prefix | Purpose |
|--------|---------|
| `/tmp/lumo/` | Testing and temporary files |
| `/private/tmp/lumo/` | macOS equivalent (symlink resolution) |
| `/home/` | User home directories |
| `/etc/nginx/` | Nginx configuration |
| `/etc/php/` | PHP configuration |
| `/etc/redis/` | Redis configuration |
| `/etc/supervisor/` | Supervisor configuration |
| `/etc/memcached/` | Memcached configuration |
| `/etc/ssl/` | SSL certificates |
| `/etc/letsencrypt/` | Let's Encrypt certificates |
| `/var/log/` | Log files |
| `/var/www/` | Web server document roots |

Additional path prefixes can be configured via the whitelist configuration.

### Protected Files

The following system files are explicitly protected and cannot be modified, even if they fall within an allowed prefix:

| File | Reason |
|------|--------|
| `/etc/passwd` | User account database |
| `/etc/shadow` | Password hashes |
| `/etc/sudoers` | Sudo privileges |
| `/etc/hosts` | Host name resolution |
| `/etc/resolv.conf` | DNS resolver configuration |

### Path Traversal Protection

The daemon implements multiple layers of protection against path traversal attacks:

1. **Raw Path Check**: Rejects any path containing `..` sequences before processing
2. **Canonicalization**: Resolves the path to its absolute form after symlink resolution
3. **Post-Canonicalization Validation**: Re-validates the canonical path against allowed prefixes

Example of blocked traversal attempts:
- `/tmp/lumo/../../../etc/passwd` - Blocked at raw path check
- `/tmp/lumo/subdir/../../outside` - Blocked at raw path check

### Symlink Protection

To prevent TOCTOU (Time-of-Check-Time-of-Use) attacks, the daemon:

1. **Checks each path component** using `symlink_metadata` (lstat) to detect symlinks without following them
2. **Rejects paths containing symlinks** that could redirect operations outside allowed directories
3. **Allows known safe system symlinks** such as:
   - `/tmp` -> `/private/tmp` (macOS)
   - `/var` -> `/private/var` (macOS)
   - `/home` -> `/System/Volumes/Data/home` (macOS)

---

## Atomic Write Pattern

Both `file.write` and `file.write_template` use an atomic write pattern to prevent partial writes and data corruption:

1. **Generate Unique Temp File**: Creates a temporary file with format `.{filename}.{uuid}.tmp`
2. **Exclusive Creation**: Uses `O_EXCL` flag (`create_new()`) to prevent symlink pre-creation attacks
3. **Write Content**: Writes all content to the temporary file
4. **Sync to Disk**: Calls `fsync()` to ensure data is persisted
5. **Set Permissions**: Applies mode and ownership to temp file (if specified)
6. **Atomic Rename**: Renames temp file to target path (atomic on POSIX systems)

This pattern ensures that:
- Readers never see partial content
- System crashes don't leave corrupted files
- Race conditions are prevented through exclusive file creation

---

## Commands

### file.write

Write content to a file with atomic write semantics.

#### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `path` | string | Yes | The file path to write to |
| `content` | string | Yes | The content to write |
| `owner` | integer | No | Owner UID for the file |
| `group` | integer | No | Group GID for the file |
| `mode` | string | No | File permissions in octal (e.g., "0644") |

#### Response Format

```json
{
  "success": true,
  "data": {
    "path": "/path/to/file.txt",
    "bytes_written": 1234
  }
}
```

#### Example Request

```json
{
  "command": "file.write",
  "params": {
    "path": "/var/www/html/index.html",
    "content": "<!DOCTYPE html><html><body>Hello</body></html>",
    "owner": 33,
    "group": 33,
    "mode": "0644"
  },
  "timestamp": 1704067200,
  "nonce": "550e8400-e29b-41d4-a716-446655440000",
  "signature": "a1b2c3d4..."
}
```

#### Example Response

```json
{
  "success": true,
  "request_id": "7f3c8a2e-1b4d-4c6f-9e8a-2b5d7c9e0f1a",
  "data": {
    "path": "/var/www/html/index.html",
    "bytes_written": 46
  }
}
```

#### Error Cases

| Error | Condition |
|-------|-----------|
| `MissingParameter` | `path` or `content` not provided |
| `PathNotAllowed` | Path does not start with an allowed prefix |
| `PathTraversal` | Path contains `..` or symlink escape attempt |
| `ProtectedFile` | Attempting to write to a protected system file |
| `ExecutionFailed` | Failed to create parent directory, write content, or set permissions |
| `InvalidParameter` | Invalid octal mode string |

---

### file.write_template

Render a Tera template with provided context and write the result to a file.

#### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `path` | string | Yes | The file path to write to |
| `template` | string | Yes | Template name (e.g., "nginx/site.conf.tera") |
| `context` | object | Yes | Template context variables as JSON object |
| `owner` | integer | No | Owner UID for the file |
| `group` | integer | No | Group GID for the file |
| `mode` | string | No | File permissions in octal (e.g., "0644") |

#### Response Format

```json
{
  "success": true,
  "data": {
    "path": "/path/to/file.conf",
    "template": "nginx/site.conf.tera",
    "bytes_written": 1234
  }
}
```

#### Example Request

```json
{
  "command": "file.write_template",
  "params": {
    "path": "/etc/nginx/sites-available/example.com.conf",
    "template": "nginx/site.conf.tera",
    "context": {
      "domain": "example.com",
      "document_root": "/var/www/example.com/public",
      "php_version": "8.2"
    },
    "owner": 0,
    "group": 0,
    "mode": "0644"
  },
  "timestamp": 1704067200,
  "nonce": "660e8400-e29b-41d4-a716-446655440001",
  "signature": "b2c3d4e5..."
}
```

#### Example Response

```json
{
  "success": true,
  "request_id": "8f4c9a3e-2b5d-4c7f-ae9a-3c6e8d0f2b1c",
  "data": {
    "path": "/etc/nginx/sites-available/example.com.conf",
    "template": "nginx/site.conf.tera",
    "bytes_written": 892
  }
}
```

#### Error Cases

| Error | Condition |
|-------|-----------|
| `MissingParameter` | `path`, `template`, or `context` not provided |
| `Template` | Template not found or render error |
| `PathNotAllowed` | Path does not start with an allowed prefix |
| `PathTraversal` | Path contains `..` or symlink escape attempt |
| `ProtectedFile` | Attempting to write to a protected system file |
| `ExecutionFailed` | Failed to create parent directory, write content, or set permissions |
| `InvalidParameter` | Invalid octal mode string |

---

### file.delete

Delete a file. This command only deletes files, not directories.

#### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `path` | string | Yes | The file path to delete |

#### Response Format

Success (file deleted):
```json
{
  "success": true,
  "data": {
    "path": "/path/to/file.txt",
    "deleted": true
  }
}
```

Success (file did not exist):
```json
{
  "success": true,
  "data": {
    "path": "/path/to/file.txt",
    "deleted": false,
    "reason": "File does not exist"
  }
}
```

#### Example Request

```json
{
  "command": "file.delete",
  "params": {
    "path": "/var/www/html/old-file.txt"
  },
  "timestamp": 1704067200,
  "nonce": "770e8400-e29b-41d4-a716-446655440002",
  "signature": "c3d4e5f6..."
}
```

#### Example Response

```json
{
  "success": true,
  "request_id": "9f5c0a4e-3c6d-4d8f-be0a-4d7f9e1f3c2d",
  "data": {
    "path": "/var/www/html/old-file.txt",
    "deleted": true
  }
}
```

#### Error Cases

| Error | Condition |
|-------|-----------|
| `MissingParameter` | `path` not provided |
| `PathNotAllowed` | Path does not start with an allowed prefix |
| `PathTraversal` | Path contains `..` or symlink escape attempt |
| `ProtectedFile` | Attempting to delete a protected system file |
| `ExecutionFailed` | Path is a directory (use `file.rmdir` instead) or deletion failed |

---

### file.mkdir

Create a directory with optional ownership and permissions.

#### Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `path` | string | Yes | - | The directory path to create |
| `owner` | integer | No | - | Owner UID for the directory |
| `group` | integer | No | - | Group GID for the directory |
| `mode` | string | No | - | Directory permissions in octal (e.g., "0755") |
| `recursive` | boolean | No | `true` | Create parent directories if needed |

#### Response Format

Success (directory created):
```json
{
  "success": true,
  "data": {
    "path": "/path/to/directory",
    "created": true
  }
}
```

Success (directory already exists):
```json
{
  "success": true,
  "data": {
    "path": "/path/to/directory",
    "created": false,
    "reason": "Directory already exists"
  }
}
```

#### Example Request

```json
{
  "command": "file.mkdir",
  "params": {
    "path": "/var/www/example.com/public",
    "owner": 33,
    "group": 33,
    "mode": "0755",
    "recursive": true
  },
  "timestamp": 1704067200,
  "nonce": "880e8400-e29b-41d4-a716-446655440003",
  "signature": "d4e5f6g7..."
}
```

#### Example Response

```json
{
  "success": true,
  "request_id": "af6c1a5e-4d7e-4e9f-cf1a-5e8g0f2g4d3e",
  "data": {
    "path": "/var/www/example.com/public",
    "created": true
  }
}
```

#### Error Cases

| Error | Condition |
|-------|-----------|
| `MissingParameter` | `path` not provided |
| `PathNotAllowed` | Path does not start with an allowed prefix |
| `PathTraversal` | Path contains `..` or symlink escape attempt |
| `ExecutionFailed` | Path exists but is not a directory, or creation failed |
| `InvalidParameter` | Invalid octal mode string |

---

### file.chmod

Set file or directory permissions, with optional recursive application.

#### Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `path` | string | Yes | - | The path to modify |
| `mode` | string | Yes | - | Permissions in octal (e.g., "0644") |
| `recursive` | boolean | No | `false` | Apply recursively to directories |

#### Response Format

```json
{
  "success": true,
  "data": {
    "path": "/path/to/target",
    "mode": "0755",
    "files_modified": 42
  }
}
```

#### Example Request

```json
{
  "command": "file.chmod",
  "params": {
    "path": "/var/www/example.com",
    "mode": "0755",
    "recursive": true
  },
  "timestamp": 1704067200,
  "nonce": "990e8400-e29b-41d4-a716-446655440004",
  "signature": "e5f6g7h8..."
}
```

#### Example Response

```json
{
  "success": true,
  "request_id": "bf7c2a6e-5e8f-4f0g-dg2a-6f9h1g3h5e4f",
  "data": {
    "path": "/var/www/example.com",
    "mode": "0755",
    "files_modified": 127
  }
}
```

#### Recursive Behavior

When `recursive` is `true` and the path is a directory:

1. Sets permissions on the directory itself
2. Recursively processes all files and subdirectories
3. **Skips symlinks** to prevent escaping validated paths
4. Uses `symlink_metadata` (lstat) to detect symlinks without following them
5. Returns total count of modified files and directories

#### Error Cases

| Error | Condition |
|-------|-----------|
| `MissingParameter` | `path` or `mode` not provided |
| `PathNotAllowed` | Path does not start with an allowed prefix |
| `PathTraversal` | Path contains `..` or symlink escape attempt |
| `ExecutionFailed` | Path does not exist, is a symlink, or permission change failed |
| `InvalidParameter` | Invalid octal mode string |

---

## Mode String Format

The `mode` parameter accepts octal permission strings in these formats:

| Format | Example | Result |
|--------|---------|--------|
| With leading zero | `"0644"` | `rw-r--r--` |
| Without leading zero | `"644"` | `rw-r--r--` |
| Executable | `"0755"` | `rwxr-xr-x` |
| Restrictive | `"0600"` | `rw-------` |

Common permission modes:

| Mode | Meaning | Use Case |
|------|---------|----------|
| `0644` | Owner read/write, others read | Regular files |
| `0755` | Owner all, others read/execute | Directories, scripts |
| `0600` | Owner read/write only | Private keys, secrets |
| `0700` | Owner all only | Private directories |
| `0640` | Owner read/write, group read | Group-shared files |

---

## UID/GID Validation

The `owner` and `group` parameters are validated:

- Must be valid integer values
- UID must be in valid range (0-65534 typically)
- GID must be in valid range (0-65534 typically)
- Setting ownership requires root privileges

If ownership cannot be set (e.g., not running as root), the command will fail with an `ExecutionFailed` error.
