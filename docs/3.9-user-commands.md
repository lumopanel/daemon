# User Commands

Commands for managing system users. These commands provide functionality for creating and deleting system users with appropriate security validations.

## Table of Contents

- [user.create](#usercreate)
- [user.delete](#userdelete)
- [Validation Rules](#validation-rules)
  - [Username Validation](#username-validation)
  - [Reserved Usernames](#reserved-usernames)
  - [Allowed Shells](#allowed-shells)
  - [Home Directory Restrictions](#home-directory-restrictions)
  - [Group Management](#group-management)

---

## user.create

Creates a new system user with the specified home directory, shell, and optional group memberships.

### Description

The `user.create` command creates a new system user using the underlying `useradd` system utility. It automatically creates the user's home directory and sets up the specified shell. The command includes comprehensive validation to prevent creation of users with reserved names or unsafe configurations.

### Parameters

| Parameter  | Type     | Required | Default              | Description                                      |
|------------|----------|----------|----------------------|--------------------------------------------------|
| `username` | string   | Yes      | -                    | The username for the new user (see validation rules) |
| `shell`    | string   | No       | `/bin/bash`          | The login shell for the user (must be in allowed list) |
| `home_dir` | string   | No       | `/home/{username}`   | The home directory path (must be under /home/ or /var/) |
| `groups`   | string[] | No       | `[]`                 | List of supplementary groups for the user        |

### Response Format

On success, returns a JSON object with the created user details:

```json
{
  "success": true,
  "data": {
    "username": "string",
    "home_dir": "string",
    "shell": "string",
    "groups": ["string"]
  }
}
```

### Example Request/Response

**Basic user creation:**

Request:
```json
{
  "command": "user.create",
  "params": {
    "username": "appuser"
  }
}
```

Response:
```json
{
  "success": true,
  "data": {
    "username": "appuser",
    "home_dir": "/home/appuser",
    "shell": "/bin/bash",
    "groups": []
  }
}
```

**User creation with all options:**

Request:
```json
{
  "command": "user.create",
  "params": {
    "username": "webapp",
    "shell": "/bin/zsh",
    "home_dir": "/var/www/webapp",
    "groups": ["www-data", "docker"]
  }
}
```

Response:
```json
{
  "success": true,
  "data": {
    "username": "webapp",
    "home_dir": "/var/www/webapp",
    "shell": "/bin/zsh",
    "groups": ["www-data", "docker"]
  }
}
```

**Service account with no login:**

Request:
```json
{
  "command": "user.create",
  "params": {
    "username": "myservice",
    "shell": "/usr/sbin/nologin",
    "home_dir": "/var/lib/myservice"
  }
}
```

Response:
```json
{
  "success": true,
  "data": {
    "username": "myservice",
    "home_dir": "/var/lib/myservice",
    "shell": "/usr/sbin/nologin",
    "groups": []
  }
}
```

### Error Cases

| Exit Code | Error Message                                    | Cause                                           |
|-----------|--------------------------------------------------|-------------------------------------------------|
| 1         | Cannot update password file for user '{name}'   | Password file is locked or corrupted            |
| 2         | Invalid command syntax for useradd              | Internal error in command construction          |
| 3         | Invalid argument for useradd option             | Invalid parameter value                         |
| 4         | UID already in use                              | Duplicate UID conflict                          |
| 6         | Group does not exist: {details}                 | Specified group not found on system             |
| 9         | Username '{name}' already exists                | User with this name already exists              |
| 12        | Cannot create home directory '{path}'           | Permission denied or path issue                 |

**Validation errors:**

```json
{
  "success": false,
  "error": {
    "kind": "Validation",
    "message": "Username 'root' is reserved and cannot be used"
  }
}
```

```json
{
  "success": false,
  "error": {
    "kind": "Validation",
    "message": "Invalid shell '/bin/malicious'. Allowed shells: [\"/bin/bash\", \"/bin/sh\", ...]"
  }
}
```

```json
{
  "success": false,
  "error": {
    "kind": "Validation",
    "message": "Home directory must be under /home/ or /var/"
  }
}
```

### Timeout

30 seconds

---

## user.delete

Deletes a system user, optionally removing their home directory.

### Description

The `user.delete` command removes a system user using the underlying `userdel` system utility. Before deletion, it verifies that the user exists. It can optionally remove the user's home directory and mail spool. The command includes validation to prevent deletion of reserved system accounts.

### Parameters

| Parameter     | Type    | Required | Default | Description                                         |
|---------------|---------|----------|---------|-----------------------------------------------------|
| `username`    | string  | Yes      | -       | The username of the user to delete (see validation rules) |
| `remove_home` | boolean | No       | `false` | Whether to remove the user's home directory and mail spool |

### Response Format

On success, returns a JSON object confirming the deletion:

```json
{
  "success": true,
  "data": {
    "username": "string",
    "removed_home": boolean
  }
}
```

### Example Request/Response

**Delete user (keep home directory):**

Request:
```json
{
  "command": "user.delete",
  "params": {
    "username": "olduser"
  }
}
```

Response:
```json
{
  "success": true,
  "data": {
    "username": "olduser",
    "removed_home": false
  }
}
```

**Delete user and remove home directory:**

Request:
```json
{
  "command": "user.delete",
  "params": {
    "username": "tempuser",
    "remove_home": true
  }
}
```

Response:
```json
{
  "success": true,
  "data": {
    "username": "tempuser",
    "removed_home": true
  }
}
```

### Error Cases

| Exit Code | Error Message                                              | Cause                                      |
|-----------|------------------------------------------------------------|--------------------------------------------|
| 1         | Cannot update password file when deleting user '{name}'   | Password file is locked or corrupted       |
| 2         | Invalid command syntax for userdel                        | Internal error in command construction     |
| 6         | User '{name}' does not exist                              | User not found on system                   |
| 8         | User '{name}' is currently logged in                      | Cannot delete user with active sessions    |
| 10        | Cannot update group file when deleting user '{name}'      | Group file is locked or corrupted          |
| 12        | Cannot remove home directory for user '{name}'            | Permission denied or directory in use      |

**User does not exist:**

```json
{
  "success": false,
  "error": {
    "kind": "ExecutionFailed",
    "message": "User 'nonexistent' does not exist"
  }
}
```

**Attempting to delete reserved user:**

```json
{
  "success": false,
  "error": {
    "kind": "Validation",
    "message": "Username 'www-data' is reserved and cannot be used"
  }
}
```

### Timeout

30 seconds

---

## Validation Rules

### Username Validation

System usernames must conform to the following rules:

| Rule                        | Description                                                     |
|-----------------------------|-----------------------------------------------------------------|
| Non-empty                   | Username cannot be empty                                        |
| Maximum length              | Must not exceed 32 characters (Linux standard)                  |
| First character             | Must start with a lowercase letter (a-z)                        |
| Allowed characters          | Lowercase letters (a-z), digits (0-9), underscore (_), hyphen (-) |
| Not reserved                | Must not be a reserved system username                          |

**Valid username examples:**

- `john`
- `john_doe`
- `john-doe`
- `john123`
- `user_name-123`
- `j` (single character)
- `a` repeated 32 times (maximum length)

**Invalid username examples:**

| Username     | Reason                                    |
|--------------|-------------------------------------------|
| `John`       | Contains uppercase letter                 |
| `1john`      | Starts with a digit                       |
| `_john`      | Starts with underscore                    |
| `-john`      | Starts with hyphen                        |
| `john.doe`   | Contains period (not allowed)             |
| `john@doe`   | Contains @ symbol                         |
| `john doe`   | Contains space                            |
| `john$`      | Contains $ symbol                         |
| (empty)      | Username cannot be empty                  |
| 33+ chars    | Exceeds maximum length of 32 characters   |

### Reserved Usernames

The following usernames are reserved and cannot be created or deleted through the API. These are standard system accounts that are critical for system operation:

| Username           | Purpose                        |
|--------------------|--------------------------------|
| `root`             | Superuser account              |
| `daemon`           | System daemon account          |
| `bin`              | Binary files owner             |
| `sys`              | System account                 |
| `sync`             | Sync utility account           |
| `games`            | Games account                  |
| `man`              | Manual pages account           |
| `lp`               | Printing services              |
| `mail`             | Mail services                  |
| `news`             | News services                  |
| `uucp`             | UUCP services                  |
| `proxy`            | Proxy services                 |
| `www-data`         | Web server account             |
| `backup`           | Backup services                |
| `list`             | Mailing list services          |
| `irc`              | IRC services                   |
| `gnats`            | Bug tracking                   |
| `nobody`           | Unprivileged account           |
| `systemd-network`  | systemd network services       |
| `systemd-resolve`  | systemd DNS resolver           |
| `messagebus`       | D-Bus message bus              |
| `sshd`             | SSH daemon                     |
| `mysql`            | MySQL database server          |
| `postgres`         | PostgreSQL database server     |
| `redis`            | Redis server                   |
| `nginx`            | Nginx web server               |
| `apache`           | Apache web server              |
| `_apt`             | APT package manager            |

### Allowed Shells

When creating a user, the `shell` parameter must be one of the following allowed shells:

| Shell               | Purpose                                           |
|---------------------|---------------------------------------------------|
| `/bin/bash`         | Bash shell (default)                              |
| `/bin/sh`           | POSIX shell                                       |
| `/usr/bin/bash`     | Bash shell (alternate path)                       |
| `/usr/bin/sh`       | POSIX shell (alternate path)                      |
| `/bin/zsh`          | Z shell                                           |
| `/usr/bin/zsh`      | Z shell (alternate path)                          |
| `/usr/sbin/nologin` | Prevents interactive login (for service accounts) |
| `/bin/false`        | Prevents any login (for locked accounts)          |

**Note:** Using `/usr/sbin/nologin` or `/bin/false` is recommended for service accounts that should not have interactive login capabilities.

### Home Directory Restrictions

Home directories must meet the following requirements:

| Requirement         | Description                                             |
|---------------------|---------------------------------------------------------|
| Absolute path       | Must start with `/`                                     |
| Allowed locations   | Must be under `/home/` or `/var/`                       |

**Valid home directory examples:**

- `/home/appuser`
- `/home/john_doe`
- `/var/www/webapp`
- `/var/lib/myservice`

**Invalid home directory examples:**

| Path              | Reason                                      |
|-------------------|---------------------------------------------|
| `home/user`       | Relative path (must start with /)           |
| `/etc/myapp`      | Not under /home/ or /var/                   |
| `/root/myapp`     | Not under /home/ or /var/                   |
| `/opt/myapp`      | Not under /home/ or /var/                   |

### Group Management

Supplementary groups can be specified when creating a user. Group names must meet the following requirements:

| Requirement         | Description                                            |
|---------------------|--------------------------------------------------------|
| Length              | Must be 1-32 characters                                |
| Allowed characters  | Alphanumeric characters (a-z, A-Z, 0-9), underscore (_), hyphen (-) |
| Existence           | Groups must exist on the system (verified during execution) |

**Valid group specifications:**

```json
{
  "groups": ["www-data", "docker"]
}
```

```json
{
  "groups": ["developers", "sudo", "admin_team"]
}
```

**Note:** If a specified group does not exist on the system, the `user.create` command will fail with exit code 6 and an error message indicating which group was not found.

**Group name validation errors:**

```json
{
  "success": false,
  "error": {
    "kind": "Validation",
    "message": "Invalid group name '': must be 1-32 characters"
  }
}
```

```json
{
  "success": false,
  "error": {
    "kind": "Validation",
    "message": "Invalid group name 'admin@group': contains invalid characters"
  }
}
```
