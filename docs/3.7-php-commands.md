# PHP Commands

PHP commands manage PHP versions, extensions, and configuration on the server. All PHP commands require the `ppa:ondrej/php` repository to be configured on the system.

## Prerequisites

The daemon expects PHP packages to be available from the Ondrej PPA repository. This repository provides up-to-date PHP packages for Ubuntu/Debian systems:

```bash
add-apt-repository ppa:ondrej/php
apt-get update
```

## Supported PHP Versions

The following PHP versions are supported:

| Version | Status |
|---------|--------|
| 8.1     | Supported |
| 8.2     | Supported |
| 8.3     | Supported |
| 8.4     | Supported |

Additional versions can be enabled via the daemon configuration whitelist.

---

## php.install_version

Installs a PHP version with PHP-FPM and common modules.

### Description

This command installs the specified PHP version along with FPM (FastCGI Process Manager) and CLI components. The installation uses `apt-get` with the `--no-install-recommends` flag for a minimal installation.

### Parameters

| Parameter | Type   | Required | Description |
|-----------|--------|----------|-------------|
| `version` | string | Yes      | PHP version to install (8.1, 8.2, 8.3, or 8.4) |

### Installed Packages

For each version, the following packages are installed:
- `php{version}-fpm` - FastCGI Process Manager
- `php{version}-cli` - Command Line Interface
- `php{version}-common` - Common files

### Response Format

**Success Response:**

```json
{
  "success": true,
  "data": {
    "version": "8.2",
    "packages": [
      "php8.2-fpm",
      "php8.2-cli",
      "php8.2-common"
    ],
    "installed": true
  }
}
```

**Failure Response:**

```json
{
  "success": false,
  "error": {
    "code": "PHP_INSTALL_FAILED",
    "message": "Failed to install PHP 8.2: E: Unable to locate package php8.2-fpm"
  }
}
```

### Example Request

```json
{
  "command": "php.install_version",
  "params": {
    "version": "8.3"
  }
}
```

### Error Cases

| Error Code | Description |
|------------|-------------|
| `VALIDATION_ERROR` | Invalid or unsupported PHP version |
| `APT_UPDATE_FAILED` | Failed to update package lists |
| `PHP_INSTALL_FAILED` | Package installation failed |

### Notes

- Installation timeout: 600 seconds (10 minutes)
- Requires `apt-get update` to be run first (handled automatically)
- The command will fail if the Ondrej PPA is not configured

---

## php.remove_version

Removes a PHP version and all associated packages.

### Description

This command removes the specified PHP version and all related packages (extensions, modules, etc.) using a wildcard pattern. This is a destructive operation that purges all configuration files.

### Parameters

| Parameter | Type   | Required | Description |
|-----------|--------|----------|-------------|
| `version` | string | Yes      | PHP version to remove (8.1, 8.2, 8.3, or 8.4) |

### Response Format

**Success Response:**

```json
{
  "success": true,
  "data": {
    "version": "8.2",
    "removed": true
  }
}
```

**Failure Response:**

```json
{
  "success": false,
  "error": {
    "code": "PHP_REMOVE_FAILED",
    "message": "Failed to remove PHP 8.2: E: Unable to locate package php8.2*"
  }
}
```

### Example Request

```json
{
  "command": "php.remove_version",
  "params": {
    "version": "8.1"
  }
}
```

### Error Cases

| Error Code | Description |
|------------|-------------|
| `VALIDATION_ERROR` | Invalid or unsupported PHP version |
| `PHP_REMOVE_FAILED` | Package removal failed |

### Notes

- Removal timeout: 300 seconds (5 minutes)
- Uses `apt-get remove -y --purge php{version}*` pattern
- All extensions for this version will also be removed
- Configuration files are purged (not preserved)

---

## php.install_extension

Installs a PHP extension for a specific PHP version.

### Description

This command installs a whitelisted PHP extension for the specified PHP version. Only extensions from the allowed list can be installed for security reasons.

### Parameters

| Parameter   | Type   | Required | Description |
|-------------|--------|----------|-------------|
| `version`   | string | Yes      | PHP version (8.1, 8.2, 8.3, or 8.4) |
| `extension` | string | Yes      | Extension name (e.g., "redis", "imagick") |

### Allowed Extensions Whitelist

The following extensions are allowed by default:

| Category | Extensions |
|----------|------------|
| **Math/Compression** | `bcmath`, `bz2`, `gmp`, `zip` |
| **Database** | `mysql`, `pgsql`, `sqlite3`, `odbc`, `dba`, `interbase`, `sybase` |
| **Networking** | `curl`, `ldap`, `snmp`, `soap`, `imap` |
| **Text/XML** | `mbstring`, `xml`, `xmlrpc`, `xsl`, `tidy`, `intl`, `enchant`, `pspell` |
| **Graphics** | `gd`, `imagick` |
| **Caching** | `redis`, `memcached`, `apcu`, `opcache` |
| **Other** | `readline` |

Additional extensions can be enabled via the daemon configuration whitelist.

### Response Format

**Success Response:**

```json
{
  "success": true,
  "data": {
    "version": "8.2",
    "extension": "redis",
    "package": "php8.2-redis",
    "installed": true
  }
}
```

**Failure Response:**

```json
{
  "success": false,
  "error": {
    "code": "EXTENSION_INSTALL_FAILED",
    "message": "Failed to install PHP extension redis: E: Unable to locate package php8.2-redis"
  }
}
```

### Example Request

```json
{
  "command": "php.install_extension",
  "params": {
    "version": "8.3",
    "extension": "imagick"
  }
}
```

### Error Cases

| Error Code | Description |
|------------|-------------|
| `VALIDATION_ERROR` | Invalid PHP version or extension not in whitelist |
| `EXTENSION_INSTALL_FAILED` | Package installation failed |

### Notes

- Installation timeout: 300 seconds (5 minutes)
- Uses `apt-get install -y --no-install-recommends` for minimal installation
- Extension names should not include the `php{version}-` prefix

---

## php.write_ini

Writes custom PHP INI settings to a configuration file.

### Description

This command writes PHP INI settings to a custom configuration file that is loaded by PHP-FPM. Settings are written to `/etc/php/{version}/fpm/conf.d/99-custom.ini` with the `99-` prefix ensuring they are loaded last and override default settings.

### Parameters

| Parameter  | Type   | Required | Description |
|------------|--------|----------|-------------|
| `version`  | string | Yes      | PHP version (8.1, 8.2, 8.3, or 8.4) |
| `settings` | object | Yes      | Key-value pairs of INI settings |

### Settings Object

The `settings` parameter accepts an object where:
- Keys are valid PHP INI directive names
- Values can be strings, numbers, or booleans

Boolean values are automatically converted:
- `true` becomes `On`
- `false` becomes `Off`

### Safe INI Settings (Examples)

The following are examples of commonly used safe settings:

| Setting | Description | Example Value |
|---------|-------------|---------------|
| `memory_limit` | Maximum memory per script | `"256M"` |
| `upload_max_filesize` | Maximum upload file size | `"64M"` |
| `post_max_size` | Maximum POST data size | `"64M"` |
| `max_execution_time` | Maximum script execution time | `30` |
| `max_input_time` | Maximum input parsing time | `60` |
| `max_input_vars` | Maximum input variables | `3000` |
| `session.gc_maxlifetime` | Session garbage collection lifetime | `1440` |
| `date.timezone` | Default timezone | `"UTC"` |
| `error_reporting` | Error reporting level | `"E_ALL"` |
| `display_errors` | Display errors (dev only) | `false` |
| `log_errors` | Log errors | `true` |
| `opcache.memory_consumption` | OPcache memory size | `128` |
| `opcache.interned_strings_buffer` | OPcache strings buffer | `8` |
| `opcache.max_accelerated_files` | OPcache max cached files | `10000` |
| `realpath_cache_size` | Realpath cache size | `"4096K"` |
| `realpath_cache_ttl` | Realpath cache TTL | `600` |

### Dangerous/Blocked INI Settings

The following settings are blocked for security reasons and will cause a validation error:

| Setting | Reason |
|---------|--------|
| `disable_functions` | Security: Controls function availability |
| `disable_classes` | Security: Controls class availability |
| `open_basedir` | Security: Filesystem access restriction |
| `safe_mode` | Security: Legacy safe mode setting |
| `extension_dir` | Security: Extension loading directory |
| `extension` | Security: Direct extension loading |
| `zend_extension` | Security: Direct Zend extension loading |

### INI Key Validation Rules

- Keys cannot be empty
- Maximum key length: 128 characters
- Allowed characters: alphanumeric, underscore (`_`), dot (`.`), brackets (`[`, `]`)
- Keys are case-insensitive when checking against blocked list

### Response Format

**Success Response:**

```json
{
  "success": true,
  "data": {
    "version": "8.2",
    "path": "/etc/php/8.2/fpm/conf.d/99-custom.ini",
    "written": true
  }
}
```

**Failure Response:**

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "INI key 'disable_functions' is not allowed for security reasons"
  }
}
```

### Example Request

```json
{
  "command": "php.write_ini",
  "params": {
    "version": "8.2",
    "settings": {
      "memory_limit": "512M",
      "upload_max_filesize": "128M",
      "post_max_size": "128M",
      "max_execution_time": 60,
      "display_errors": false,
      "log_errors": true,
      "opcache.enable": true,
      "opcache.memory_consumption": 256
    }
  }
}
```

### Generated INI File

The command generates a file like:

```ini
; Custom PHP settings managed by Lumo
; Do not edit manually - changes will be overwritten

memory_limit = 512M
upload_max_filesize = 128M
post_max_size = 128M
max_execution_time = 60
display_errors = Off
log_errors = On
opcache.enable = On
opcache.memory_consumption = 256
```

### Error Cases

| Error Code | Description |
|------------|-------------|
| `VALIDATION_ERROR` | Invalid PHP version, invalid setting key, or blocked setting |
| `EXECUTION_FAILED` | Failed to create directory or write file |

### Notes

- File permissions are set to `0644`
- Parent directories are created if they don't exist
- The file is completely overwritten on each call (not merged)
- PHP-FPM must be reloaded for settings to take effect

---

## Security Considerations

### Extension Whitelist

Only extensions from the predefined whitelist can be installed. This prevents:
- Installation of untrusted or malicious extensions
- Installation of development-only extensions in production
- Arbitrary package installation via extension names

### INI Settings Restrictions

Certain INI settings are blocked because they could:
- Disable security functions (`disable_functions`, `disable_classes`)
- Bypass filesystem restrictions (`open_basedir`)
- Load arbitrary code (`extension`, `zend_extension`, `extension_dir`)

### Version Validation

PHP versions are strictly validated against the allowed list (8.1-8.4) to prevent:
- Installation of unsupported or EOL versions
- Arbitrary package name injection

---

## Configuration Extension

Additional PHP versions and extensions can be enabled via the daemon configuration whitelist. See the validation whitelist documentation for details on:

- `is_additional_php_version()` - Check for additional allowed versions
- `is_additional_php_extension()` - Check for additional allowed extensions
