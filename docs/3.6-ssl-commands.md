# SSL Commands

SSL/Certificate management commands for installing certificates and requesting Let's Encrypt certificates.

## Table of Contents

- [ssl.install_cert](#sslinstall_cert)
- [ssl.request_letsencrypt](#sslrequest_letsencrypt)
- [Domain Validation Rules](#domain-validation-rules)
- [Certificate Format Requirements](#certificate-format-requirements)
- [Certificate Storage Locations](#certificate-storage-locations)
- [Let's Encrypt Integration](#lets-encrypt-integration)

---

## ssl.install_cert

Install an SSL certificate for a domain.

### Description

Installs a provided SSL certificate, private key, and optional certificate chain for a specified domain. The command validates both the certificate and key formats, ensures they match, and stores them in the appropriate system directories with correct permissions.

### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `domain` | string | Yes | The domain name for the certificate (e.g., `example.com`) |
| `certificate` | string | Yes | The certificate content in PEM format |
| `private_key` | string | Yes | The private key content in PEM format |
| `chain` | string | No | The certificate chain content in PEM format |

### Response Format

#### Success Response

```json
{
  "success": true,
  "data": {
    "domain": "example.com",
    "cert_path": "/etc/ssl/certs/example.com.crt",
    "key_path": "/etc/ssl/private/example.com.key",
    "chain_path": "/etc/ssl/certs/example.com.chain.crt",
    "installed": true
  }
}
```

#### Failure Response

```json
{
  "success": false,
  "error": {
    "code": "CERTIFICATE_INVALID",
    "message": "Certificate verification failed: Certificate and private key do not match"
  }
}
```

### Example Request/Response

#### Request

```json
{
  "command": "ssl.install_cert",
  "params": {
    "domain": "example.com",
    "certificate": "-----BEGIN CERTIFICATE-----\nMIIFazCCA1OgAwIBAgIUe...\n-----END CERTIFICATE-----",
    "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhki...\n-----END PRIVATE KEY-----",
    "chain": "-----BEGIN CERTIFICATE-----\nMIIFYDCCBEigAwIBAgI...\n-----END CERTIFICATE-----"
  }
}
```

#### Response (Success)

```json
{
  "success": true,
  "data": {
    "domain": "example.com",
    "cert_path": "/etc/ssl/certs/example.com.crt",
    "key_path": "/etc/ssl/private/example.com.key",
    "chain_path": "/etc/ssl/certs/example.com.chain.crt",
    "installed": true
  }
}
```

#### Response (Without Chain)

```json
{
  "success": true,
  "data": {
    "domain": "example.com",
    "cert_path": "/etc/ssl/certs/example.com.crt",
    "key_path": "/etc/ssl/private/example.com.key",
    "chain_path": null,
    "installed": true
  }
}
```

### Error Cases

| Error Code | Description |
|------------|-------------|
| `MISSING_PARAMETER` | Required parameter `domain`, `certificate`, or `private_key` is missing |
| `INVALID_PARAMETER` | Domain validation failed, or certificate/key is not in valid PEM format |
| `EXECUTION_FAILED` | Failed to create directories, write files, or set permissions |
| `CERTIFICATE_INVALID` | Certificate verification failed (e.g., certificate and key do not match) |

---

## ssl.request_letsencrypt

Request a Let's Encrypt certificate using certbot.

### Description

Requests and obtains a free SSL certificate from Let's Encrypt using the certbot tool. Uses the webroot plugin for HTTP-01 domain validation challenge. The certificate is automatically stored in the standard certbot locations and can be renewed automatically.

### Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `domain` | string | Yes | - | The domain name for the certificate |
| `email` | string | Yes | - | Email address for Let's Encrypt notifications and account recovery |
| `webroot` | string | Yes | - | Path to the webroot directory for HTTP-01 challenge verification |
| `staging` | boolean | No | `false` | Use Let's Encrypt staging server for testing (recommended for development) |

### Response Format

#### Success Response

```json
{
  "success": true,
  "data": {
    "domain": "example.com",
    "cert_path": "/etc/letsencrypt/live/example.com/fullchain.pem",
    "key_path": "/etc/letsencrypt/live/example.com/privkey.pem",
    "staging": false,
    "obtained": true
  }
}
```

#### Failure Response

```json
{
  "success": false,
  "error": {
    "code": "LETSENCRYPT_FAILED",
    "message": "Failed to obtain Let's Encrypt certificate: Domain validation failed"
  }
}
```

### Example Request/Response

#### Request (Production)

```json
{
  "command": "ssl.request_letsencrypt",
  "params": {
    "domain": "example.com",
    "email": "admin@example.com",
    "webroot": "/var/www/html"
  }
}
```

#### Response (Success)

```json
{
  "success": true,
  "data": {
    "domain": "example.com",
    "cert_path": "/etc/letsencrypt/live/example.com/fullchain.pem",
    "key_path": "/etc/letsencrypt/live/example.com/privkey.pem",
    "staging": false,
    "obtained": true
  }
}
```

#### Request (Staging/Testing)

```json
{
  "command": "ssl.request_letsencrypt",
  "params": {
    "domain": "test.example.com",
    "email": "admin@example.com",
    "webroot": "/var/www/test",
    "staging": true
  }
}
```

#### Response (Staging Success)

```json
{
  "success": true,
  "data": {
    "domain": "test.example.com",
    "cert_path": "/etc/letsencrypt/live/test.example.com/fullchain.pem",
    "key_path": "/etc/letsencrypt/live/test.example.com/privkey.pem",
    "staging": true,
    "obtained": true
  }
}
```

### Error Cases

| Error Code | Description |
|------------|-------------|
| `MISSING_PARAMETER` | Required parameter `domain`, `email`, or `webroot` is missing |
| `INVALID_PARAMETER` | Domain validation failed, email format is invalid, or webroot path is invalid |
| `LETSENCRYPT_FAILED` | Certbot failed to obtain certificate (e.g., domain validation failed, rate limit exceeded) |

---

## Domain Validation Rules

All domain names are validated according to the following rules:

### Length Constraints

| Constraint | Value |
|------------|-------|
| Maximum domain length | 253 characters |
| Maximum label length | 63 characters per label |
| Minimum labels | 2 (must have at least domain + TLD) |

### Format Rules

1. **Labels**: Domain is split by dots (`.`) into labels
2. **First character**: Each label must start with an alphanumeric character (a-z, A-Z, 0-9)
3. **Last character**: Each label must end with an alphanumeric character
4. **Middle characters**: Labels can contain alphanumeric characters and hyphens (`-`)
5. **No wildcards**: Wildcard domains (containing `*`) are not allowed for security reasons
6. **No trailing dot**: Trailing dots are automatically stripped
7. **No empty labels**: Consecutive dots (`..`) are not allowed

### Valid Domain Examples

```
example.com
sub.example.com
my-site.example.org
a1.b2.c3.example.net
```

### Invalid Domain Examples

| Domain | Reason |
|--------|--------|
| `localhost` | No TLD (single label) |
| `*.example.com` | Wildcard not allowed |
| `example_site.com` | Underscore not allowed in domain |
| `example site.com` | Space not allowed |
| `-example.com` | Label starts with hyphen |
| `example-.com` | Label ends with hyphen |
| `example..com` | Empty label (consecutive dots) |

---

## Certificate Format Requirements

### PEM Format

All certificates and keys must be in PEM (Privacy-Enhanced Mail) format.

### Certificate Requirements

The certificate must contain the PEM header:

```
-----BEGIN CERTIFICATE-----
```

Example valid certificate format:

```
-----BEGIN CERTIFICATE-----
MIIFazCCA1OgAwIBAgIUe5kVbLHlzJxPQN...
(base64 encoded certificate data)
...
-----END CERTIFICATE-----
```

### Private Key Requirements

The private key must contain a PEM header indicating a private key. Accepted formats include:

- `-----BEGIN PRIVATE KEY-----` (PKCS#8)
- `-----BEGIN RSA PRIVATE KEY-----` (PKCS#1)
- `-----BEGIN EC PRIVATE KEY-----` (EC key)

Example valid private key format:

```
-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgw...
(base64 encoded key data)
...
-----END PRIVATE KEY-----
```

### Certificate Chain (Optional)

The certificate chain should contain intermediate certificates in PEM format:

```
-----BEGIN CERTIFICATE-----
(Intermediate CA certificate)
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
(Root CA certificate - optional)
-----END CERTIFICATE-----
```

### Verification

The daemon verifies that the certificate and private key match by comparing their modulus values using OpenSSL:

```bash
# Certificate modulus
openssl x509 -noout -modulus -in /path/to/cert.crt

# Private key modulus
openssl rsa -noout -modulus -in /path/to/key.key
```

If the modulus values do not match, the installation fails and files are cleaned up.

---

## Certificate Storage Locations

### Manual Certificate Installation (ssl.install_cert)

| File Type | Location | Permissions |
|-----------|----------|-------------|
| Certificate | `/etc/ssl/certs/{domain}.crt` | `0644` (readable by all) |
| Private Key | `/etc/ssl/private/{domain}.key` | `0600` (owner read/write only) |
| Certificate Chain | `/etc/ssl/certs/{domain}.chain.crt` | `0644` (readable by all) |

Example paths for `example.com`:

```
/etc/ssl/certs/example.com.crt
/etc/ssl/private/example.com.key
/etc/ssl/certs/example.com.chain.crt
```

### Let's Encrypt Certificates (ssl.request_letsencrypt)

Certbot stores certificates in its standard directory structure:

| File Type | Location |
|-----------|----------|
| Full Chain | `/etc/letsencrypt/live/{domain}/fullchain.pem` |
| Private Key | `/etc/letsencrypt/live/{domain}/privkey.pem` |
| Certificate Only | `/etc/letsencrypt/live/{domain}/cert.pem` |
| Chain Only | `/etc/letsencrypt/live/{domain}/chain.pem` |

Example paths for `example.com`:

```
/etc/letsencrypt/live/example.com/fullchain.pem
/etc/letsencrypt/live/example.com/privkey.pem
/etc/letsencrypt/live/example.com/cert.pem
/etc/letsencrypt/live/example.com/chain.pem
```

---

## Let's Encrypt Integration

### Certbot Integration

The daemon uses [certbot](https://certbot.eff.org/) for Let's Encrypt certificate management.

### Command Execution

The daemon executes certbot with the following arguments:

```bash
certbot certonly \
  --webroot \
  -w /path/to/webroot \
  -d example.com \
  --email admin@example.com \
  --agree-tos \
  --non-interactive \
  --keep-until-expiring \
  [--staging]
```

### Certbot Options Explained

| Option | Description |
|--------|-------------|
| `certonly` | Obtain certificate only (don't install) |
| `--webroot` | Use webroot plugin for domain validation |
| `-w` | Webroot path for HTTP-01 challenge files |
| `-d` | Domain name for the certificate |
| `--email` | Email for urgent notices and key recovery |
| `--agree-tos` | Agree to ACME server's Subscriber Agreement |
| `--non-interactive` | Run without user interaction |
| `--keep-until-expiring` | Renew only if certificate is near expiry |
| `--staging` | Use Let's Encrypt staging server (for testing) |

### HTTP-01 Challenge

The webroot plugin works by:

1. Certbot creates a challenge file in `{webroot}/.well-known/acme-challenge/`
2. Let's Encrypt servers verify the challenge by accessing `http://{domain}/.well-known/acme-challenge/{token}`
3. Upon successful verification, the certificate is issued

**Requirements:**
- The webroot must be accessible via HTTP on port 80
- The domain must resolve to the server's IP address
- The web server must serve static files from the webroot directory

### Timeout

The certbot operation has a timeout of **300 seconds (5 minutes)** to allow for DNS propagation and challenge verification.

### Staging vs Production

| Environment | Description | Rate Limits |
|-------------|-------------|-------------|
| Production | Real, trusted certificates | 50 certificates per domain per week |
| Staging | Test certificates (not trusted) | Much higher limits for testing |

**Recommendation:** Use `staging: true` during development and testing to avoid hitting production rate limits.

### Email Validation

The email address for Let's Encrypt is validated with the following rules:

| Rule | Description |
|------|-------------|
| Non-empty | Email cannot be empty |
| Maximum length | 254 characters |
| Format | Must contain exactly one `@` symbol |
| Local part | Characters before `@` must not be empty |
| Domain part | Characters after `@` must not be empty and must contain a dot |
| Invalid characters | No whitespace, `<`, `>`, `"`, or `'` allowed |

### Certificate Renewal

Certificates obtained via `ssl.request_letsencrypt` can be renewed by calling the command again with the same parameters. The `--keep-until-expiring` flag ensures that:

- If the certificate is not near expiry, no action is taken
- If the certificate is near expiry (within 30 days), it will be renewed

For automatic renewal, consider setting up a cron job or systemd timer to run certbot:

```bash
# Cron example (run twice daily)
0 0,12 * * * certbot renew --quiet
```
