# Database Commands

Commands for creating and managing MySQL and PostgreSQL databases.

## Supported Database Types

The database commands support two database management systems:

| Type | Value | Description |
|------|-------|-------------|
| MySQL | `mysql` | MySQL/MariaDB database server |
| PostgreSQL | `postgresql` | PostgreSQL database server |

The `type` parameter is case-insensitive (e.g., `mysql`, `MySQL`, `MYSQL` are all valid).

## Validation Rules

### Database Name Validation

Database names must adhere to the following rules:

| Rule | Requirement |
|------|-------------|
| Length | 1-64 characters |
| First character | Must be a letter (a-z, A-Z) or underscore (_) |
| Allowed characters | Letters, numbers, and underscores only |
| Reserved names | Cannot use reserved database keywords |

**Valid examples:** `my_database`, `app_production`, `_private_db`, `db1`

**Invalid examples:** `my-database` (hyphen), `1database` (starts with number), `my.database` (dot), `my database` (space)

### Database Username Validation

Database usernames must adhere to the following rules:

| Rule | Requirement |
|------|-------------|
| Length | 1-32 characters |
| First character | Must be a letter (a-z, A-Z) or underscore (_) |
| Allowed characters | Letters, numbers, and underscores only |

**Valid examples:** `app_user`, `readonly`, `_admin`

**Invalid examples:** `user@host` (special character), `1user` (starts with number)

### Reserved Database Names

The following names are reserved and cannot be used as database names:

| Reserved Name | System |
|---------------|--------|
| `mysql` | MySQL |
| `information_schema` | MySQL |
| `performance_schema` | MySQL |
| `sys` | MySQL |
| `postgres` | PostgreSQL |
| `template0` | PostgreSQL |
| `template1` | PostgreSQL |
| `root` | Common |
| `admin` | Common |
| `test` | Common |

---

## database.create_db

Create a new database.

### Description

Creates a new database in the specified database management system. For MySQL, uses `CREATE DATABASE IF NOT EXISTS`. For PostgreSQL, uses the `createdb` utility.

### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `name` | string | Yes | The database name (1-64 chars, alphanumeric + underscore) |
| `type` | string | Yes | Database type: `mysql` or `postgresql` |

### Response Format

#### Success Response

```json
{
  "success": true,
  "data": {
    "name": "my_database",
    "type": "mysql",
    "created": true
  }
}
```

#### Failure Response

```json
{
  "success": false,
  "error": {
    "code": "DATABASE_CREATE_FAILED",
    "message": "Failed to create database: <error details>"
  }
}
```

### Example Request/Response

**Request:**
```json
{
  "command": "database.create_db",
  "params": {
    "name": "my_application_db",
    "type": "mysql"
  }
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "name": "my_application_db",
    "type": "mysql",
    "created": true
  }
}
```

### Error Cases

| Error Code | Condition |
|------------|-----------|
| `VALIDATION_ERROR` | Missing required parameter `name` |
| `VALIDATION_ERROR` | Missing required parameter `type` |
| `VALIDATION_ERROR` | Database name is empty |
| `VALIDATION_ERROR` | Database name exceeds 64 characters |
| `VALIDATION_ERROR` | Database name starts with a number |
| `VALIDATION_ERROR` | Database name contains invalid characters |
| `VALIDATION_ERROR` | Database name is a reserved keyword |
| `VALIDATION_ERROR` | Invalid database type (not `mysql` or `postgresql`) |
| `DATABASE_CREATE_FAILED` | Database server returned an error |

---

## database.create_user

Create a new database user with access to a specific database.

### Description

Creates a new database user and grants full privileges on the specified database. For MySQL, creates the user with `localhost` access and grants `ALL PRIVILEGES` on the database. For PostgreSQL, creates the user and grants `ALL PRIVILEGES ON DATABASE`.

### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `username` | string | Yes | The username (1-32 chars, alphanumeric + underscore) |
| `password` | string | Yes | The password for the user |
| `database` | string | Yes | The database to grant access to |
| `type` | string | Yes | Database type: `mysql` or `postgresql` |

### User Privilege Options

The created user receives the following privileges:

| Database Type | Privileges Granted |
|---------------|-------------------|
| MySQL | `ALL PRIVILEGES` on the specified database (all tables) |
| PostgreSQL | `ALL PRIVILEGES ON DATABASE` |

**MySQL specifics:**
- User is created with `@'localhost'` host restriction
- `FLUSH PRIVILEGES` is executed after granting

**PostgreSQL specifics:**
- User is created with password authentication
- Privileges are granted on the database level

### Response Format

#### Success Response

```json
{
  "success": true,
  "data": {
    "username": "app_user",
    "database": "my_database",
    "type": "mysql",
    "created": true
  }
}
```

#### Failure Response

```json
{
  "success": false,
  "error": {
    "code": "USER_CREATE_FAILED",
    "message": "Failed to create database user: <error details>"
  }
}
```

### Example Request/Response

**Request:**
```json
{
  "command": "database.create_user",
  "params": {
    "username": "app_user",
    "password": "secure_password_123",
    "database": "my_application_db",
    "type": "mysql"
  }
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "username": "app_user",
    "database": "my_application_db",
    "type": "mysql",
    "created": true
  }
}
```

### Error Cases

| Error Code | Condition |
|------------|-----------|
| `VALIDATION_ERROR` | Missing required parameter `username` |
| `VALIDATION_ERROR` | Missing required parameter `password` |
| `VALIDATION_ERROR` | Missing required parameter `database` |
| `VALIDATION_ERROR` | Missing required parameter `type` |
| `VALIDATION_ERROR` | Username is empty |
| `VALIDATION_ERROR` | Username exceeds 32 characters |
| `VALIDATION_ERROR` | Username starts with a number |
| `VALIDATION_ERROR` | Username contains invalid characters |
| `VALIDATION_ERROR` | Database name is invalid (see database name validation) |
| `VALIDATION_ERROR` | Invalid database type (not `mysql` or `postgresql`) |
| `USER_CREATE_FAILED` | Database server returned an error during user creation or privilege grant |

---

## database.drop_db

Drop an existing database.

### Description

Permanently deletes an existing database and all its data. For MySQL, uses `DROP DATABASE IF EXISTS`. For PostgreSQL, uses the `dropdb` utility with `--if-exists` flag.

**Warning:** This is a destructive operation. All data in the database will be permanently deleted.

### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `name` | string | Yes | The database name (1-64 chars, alphanumeric + underscore) |
| `type` | string | Yes | Database type: `mysql` or `postgresql` |

### Response Format

#### Success Response

```json
{
  "success": true,
  "data": {
    "name": "old_database",
    "type": "mysql",
    "dropped": true
  }
}
```

#### Failure Response

```json
{
  "success": false,
  "error": {
    "code": "DATABASE_DROP_FAILED",
    "message": "Failed to drop database: <error details>"
  }
}
```

### Example Request/Response

**Request:**
```json
{
  "command": "database.drop_db",
  "params": {
    "name": "old_application_db",
    "type": "postgresql"
  }
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "name": "old_application_db",
    "type": "postgresql",
    "dropped": true
  }
}
```

### Error Cases

| Error Code | Condition |
|------------|-----------|
| `VALIDATION_ERROR` | Missing required parameter `name` |
| `VALIDATION_ERROR` | Missing required parameter `type` |
| `VALIDATION_ERROR` | Database name is empty |
| `VALIDATION_ERROR` | Database name exceeds 64 characters |
| `VALIDATION_ERROR` | Database name starts with a number |
| `VALIDATION_ERROR` | Database name contains invalid characters |
| `VALIDATION_ERROR` | Database name is a reserved keyword (prevents dropping system databases) |
| `VALIDATION_ERROR` | Invalid database type (not `mysql` or `postgresql`) |
| `DATABASE_DROP_FAILED` | Database server returned an error |

---

## Implementation Notes

### Timeout

All database operations have a default timeout of **30 seconds**.

### Security Considerations

1. **SQL Injection Prevention:** All database names, usernames, and types are validated before use. Names can only contain alphanumeric characters and underscores.

2. **Reserved Name Protection:** System database names are protected and cannot be created or dropped.

3. **Password Handling:** Single quotes in passwords are properly escaped to prevent SQL injection.

4. **MySQL Identifier Quoting:** Database names are wrapped in backticks (`) in MySQL queries.

5. **PostgreSQL Utilities:** PostgreSQL operations use the native utilities (`createdb`, `dropdb`) which handle quoting and escaping automatically.
