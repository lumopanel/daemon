# 3.3 Service Commands

Service commands provide management capabilities for system services via `systemctl`. These commands allow starting, stopping, restarting, reloading services, as well as enabling or disabling them at boot time.

> **Note:** All requests must use the `SignedRequest` format with `command`, `params`, `timestamp`, `nonce`, and `signature` fields. See [Wire Protocol](7-wire-protocol.md) for the complete format specification. Responses use `success`, `request_id`, and `data`/`error` fields.

## Table of Contents

- [Overview](#overview)
- [Service Whitelist](#service-whitelist)
- [Service Name Validation](#service-name-validation)
- [Commands](#commands)
  - [service.start](#servicestart)
  - [service.stop](#servicestop)
  - [service.restart](#servicerestart)
  - [service.reload](#servicereload)
  - [service.enable](#serviceenable)
  - [service.disable](#servicedisable)
  - [service.status](#servicestatus)
- [Error Cases](#error-cases)

## Overview

All service commands interact with `systemctl` to manage system services. For security reasons, only whitelisted services can be managed through the daemon. Attempts to control non-whitelisted services will be rejected with a validation error.

## Service Whitelist

Only services in the allowed whitelist can be controlled. This is a security-critical list to prevent unauthorized service manipulation.

### Built-in Allowed Services

| Category | Services |
|----------|----------|
| Web Servers | `nginx` |
| PHP-FPM | `php8.1-fpm`, `php8.2-fpm`, `php8.3-fpm`, `php8.4-fpm` |
| Databases | `mysql`, `mariadb`, `postgresql`, `redis-server` |
| Cache | `memcached` |
| Process Managers | `supervisor`, `supervisord` |

### Additional Services via Configuration

Additional services can be whitelisted through the daemon configuration file using the `additional_services` setting in the `[whitelists]` section:

```toml
[whitelists]
additional_services = ["custom-service", "another-service"]
```

## Service Name Validation

Service names undergo strict validation before any operation is performed:

1. **Non-empty check**: Service name cannot be empty
2. **Whitelist check**: Service must be in the built-in whitelist or configured additional services
3. **Implicit security**: Services not in the whitelist (e.g., `ssh`, `sshd`, `cron`, `systemd`, `dbus`) are automatically rejected
4. **Injection protection**: Path injection attempts (e.g., `../etc/passwd`, shell commands) are rejected

---

## Commands

### service.start

Start a stopped service.

#### Description

Starts the specified service using `systemctl start`. The service must be in the allowed whitelist.

#### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `service` | string | Yes | Name of the service to start |

#### Response Format

| Field | Type | Description |
|-------|------|-------------|
| `service` | string | Name of the service that was started |
| `action` | string | Always `"start"` |

#### Example Request

```json
{
  "command": "service.start",
  "params": {
    "service": "nginx"
  },
  "timestamp": 1704067200,
  "nonce": "550e8400-e29b-41d4-a716-446655440000",
  "signature": "a1b2c3d4..."
}
```

#### Example Response

```json
{
  "success": true,
  "request_id": "7f3c8a2e-1b4d-4c6f-9e8a-2b5d7c9e0f1a",
  "data": {
    "service": "nginx",
    "action": "start"
  }
}
```

#### Timeout

120 seconds

---

### service.stop

Stop a running service.

#### Description

Stops the specified service using `systemctl stop`. The service must be in the allowed whitelist.

#### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `service` | string | Yes | Name of the service to stop |

#### Response Format

| Field | Type | Description |
|-------|------|-------------|
| `service` | string | Name of the service that was stopped |
| `action` | string | Always `"stop"` |

#### Example Request

```json
{
  "command": "service.stop",
  "params": {
    "service": "nginx"
  },
  "timestamp": 1704067200,
  "nonce": "660e8400-e29b-41d4-a716-446655440001",
  "signature": "b2c3d4e5..."
}
```

#### Example Response

```json
{
  "success": true,
  "request_id": "8f4c9a3e-2b5d-4c7f-ae9a-3c6e8d0f2b1c",
  "data": {
    "service": "nginx",
    "action": "stop"
  }
}
```

#### Timeout

120 seconds

---

### service.restart

Restart a service.

#### Description

Restarts the specified service using `systemctl restart`. This stops and then starts the service, reloading both configuration and the service itself.

#### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `service` | string | Yes | Name of the service to restart |

#### Response Format

| Field | Type | Description |
|-------|------|-------------|
| `service` | string | Name of the service that was restarted |
| `action` | string | Always `"restart"` |

#### Example Request

```json
{
  "command": "service.restart",
  "params": {
    "service": "php8.3-fpm"
  },
  "timestamp": 1704067200,
  "nonce": "770e8400-e29b-41d4-a716-446655440002",
  "signature": "c3d4e5f6..."
}
```

#### Example Response

```json
{
  "success": true,
  "request_id": "9f5c0a4e-3c6d-4d8f-be0a-4d7f9e1f3c2d",
  "data": {
    "service": "php8.3-fpm",
    "action": "restart"
  }
}
```

#### Timeout

120 seconds

---

### service.reload

Reload service configuration.

#### Description

Reloads the configuration of the specified service using `systemctl reload`. This is typically faster than a full restart and does not interrupt the service. Note that not all services support reload operations.

#### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `service` | string | Yes | Name of the service to reload |

#### Response Format

| Field | Type | Description |
|-------|------|-------------|
| `service` | string | Name of the service that was reloaded |
| `action` | string | Always `"reload"` |

#### Example Request

```json
{
  "command": "service.reload",
  "params": {
    "service": "nginx"
  },
  "timestamp": 1704067200,
  "nonce": "880e8400-e29b-41d4-a716-446655440003",
  "signature": "d4e5f6g7..."
}
```

#### Example Response

```json
{
  "success": true,
  "request_id": "af6c1a5e-4d7e-4e9f-cf1a-5e8g0f2g4d3e",
  "data": {
    "service": "nginx",
    "action": "reload"
  }
}
```

#### Timeout

60 seconds

---

### service.enable

Enable a service to start at boot.

#### Description

Enables the specified service to start automatically at system boot using `systemctl enable`.

#### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `service` | string | Yes | Name of the service to enable |

#### Response Format

| Field | Type | Description |
|-------|------|-------------|
| `service` | string | Name of the service that was enabled |
| `action` | string | Always `"enable"` |
| `enabled` | boolean | Always `true` on success |

#### Example Request

```json
{
  "command": "service.enable",
  "params": {
    "service": "mysql"
  },
  "timestamp": 1704067200,
  "nonce": "990e8400-e29b-41d4-a716-446655440004",
  "signature": "e5f6g7h8..."
}
```

#### Example Response

```json
{
  "success": true,
  "request_id": "bf7c2a6e-5e8f-4f0g-dg2a-6f9h1g3h5e4f",
  "data": {
    "service": "mysql",
    "action": "enable",
    "enabled": true
  }
}
```

#### Timeout

30 seconds

---

### service.disable

Disable a service from starting at boot.

#### Description

Disables the specified service from starting automatically at system boot using `systemctl disable`. This does not stop a currently running service.

#### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `service` | string | Yes | Name of the service to disable |

#### Response Format

| Field | Type | Description |
|-------|------|-------------|
| `service` | string | Name of the service that was disabled |
| `action` | string | Always `"disable"` |
| `enabled` | boolean | Always `false` on success |

#### Example Request

```json
{
  "command": "service.disable",
  "params": {
    "service": "memcached"
  },
  "timestamp": 1704067200,
  "nonce": "aa0e8400-e29b-41d4-a716-446655440005",
  "signature": "f6g7h8i9..."
}
```

#### Example Response

```json
{
  "success": true,
  "request_id": "cg8c3a7e-6f9g-5g1h-eh3a-7g0i2h4i6f5g",
  "data": {
    "service": "memcached",
    "action": "disable",
    "enabled": false
  }
}
```

#### Timeout

30 seconds

---

### service.status

Get the status of a service.

#### Description

Retrieves the current status of the specified service, including whether it is active (running), enabled (starts at boot), and its main process ID if running.

**Note**: This is a read-only query and does not require audit logging.

#### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `service` | string | Yes | Name of the service to query |

#### Response Format

| Field | Type | Description |
|-------|------|-------------|
| `service` | string | Name of the queried service |
| `active` | boolean | `true` if the service is currently running |
| `enabled` | boolean | `true` if the service is enabled to start at boot |
| `status` | string | Status string from systemctl (e.g., `"active"`, `"inactive"`, `"failed"`) |
| `pid` | integer or null | Main process ID if the service is active, `null` otherwise |

#### Example Request

```json
{
  "command": "service.status",
  "params": {
    "service": "nginx"
  },
  "timestamp": 1704067200,
  "nonce": "bb0e8400-e29b-41d4-a716-446655440006",
  "signature": "g7h8i9j0..."
}
```

#### Example Response (Running Service)

```json
{
  "success": true,
  "request_id": "dh9c4a8e-7g0h-6h2i-fi4a-8h1j3i5j7g6h",
  "data": {
    "service": "nginx",
    "active": true,
    "enabled": true,
    "status": "active",
    "pid": 12345
  }
}
```

#### Example Response (Stopped Service)

```json
{
  "success": true,
  "request_id": "dh9c4a8e-7g0h-6h2i-fi4a-8h1j3i5j7g6h",
  "data": {
    "service": "nginx",
    "active": false,
    "enabled": true,
    "status": "inactive",
    "pid": null
  }
}
```

#### Timeout

30 seconds

---

## Error Cases

All service commands can return the following errors:

### Missing Service Parameter

Returned when the `service` parameter is not provided.

```json
{
  "success": false,
  "request_id": "ei0c5a9e-8h1i-7i3j-gj5a-9i2k4j6k8h7i",
  "error": {
    "code": "MISSING_PARAMETER",
    "message": "Missing required parameter: service"
  }
}
```

### Empty Service Name

Returned when the `service` parameter is an empty string.

```json
{
  "success": false,
  "request_id": "ei0c5a9e-8h1i-7i3j-gj5a-9i2k4j6k8h7i",
  "error": {
    "code": "INVALID_PARAMETER",
    "message": "Service name cannot be empty"
  }
}
```

### Unknown Service (Not in Whitelist)

Returned when the service is not in the allowed whitelist.

```json
{
  "success": false,
  "request_id": "ei0c5a9e-8h1i-7i3j-gj5a-9i2k4j6k8h7i",
  "error": {
    "code": "UNKNOWN_SERVICE",
    "message": "Service 'malicious-service' is not in the allowed whitelist"
  }
}
```

### Execution Failed

Returned when `systemctl` fails to execute the requested operation.

```json
{
  "success": false,
  "request_id": "ei0c5a9e-8h1i-7i3j-gj5a-9i2k4j6k8h7i",
  "error": {
    "code": "EXECUTION_FAILED",
    "message": "systemctl start nginx failed: Failed to start nginx.service: Unit nginx.service not found."
  }
}
```

### Command Timeout Summary

| Command | Timeout |
|---------|---------|
| `service.start` | 120 seconds |
| `service.stop` | 120 seconds |
| `service.restart` | 120 seconds |
| `service.reload` | 60 seconds |
| `service.enable` | 30 seconds |
| `service.disable` | 30 seconds |
| `service.status` | 30 seconds |
