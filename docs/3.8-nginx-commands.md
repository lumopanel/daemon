# 3.8 Nginx Commands

This document describes the Nginx management commands available in the daemon. These commands provide site management and configuration testing capabilities.

## Overview

The Nginx commands module provides three commands for managing Nginx sites:

| Command | Description |
|---------|-------------|
| `nginx.enable_site` | Enable a site by creating a symlink from sites-available to sites-enabled |
| `nginx.disable_site` | Disable a site by removing the symlink from sites-enabled |
| `nginx.test_config` | Test the Nginx configuration for syntax errors |

## Site Name Validation

All commands that accept a `site_name` parameter apply strict validation rules to prevent security issues:

### Validation Rules

| Rule | Description |
|------|-------------|
| Length | Must be 1-64 characters |
| First character | Must start with an alphanumeric character (a-z, A-Z, 0-9) |
| Allowed characters | Alphanumeric characters, dots (`.`), dashes (`-`), and underscores (`_`) |
| Path traversal | Sequences like `..` are explicitly rejected |

### Valid Examples

- `example.com`
- `my-site`
- `site_config`
- `default`
- `api.example.com`

### Invalid Examples

- `../etc/passwd` - path traversal attempt
- `site..conf` - contains `..` sequence
- `site/config` - contains slash
- `.hidden` - starts with non-alphanumeric
- `-invalid` - starts with dash

## sites-available vs sites-enabled

The daemon follows the standard Nginx site management pattern using two directories:

| Directory | Purpose |
|-----------|---------|
| `/etc/nginx/sites-available/` | Contains all site configuration files |
| `/etc/nginx/sites-enabled/` | Contains symlinks to enabled configurations |

### How It Works

1. Site configuration files are stored in `sites-available/`
2. To enable a site, a symlink is created in `sites-enabled/` pointing to the configuration in `sites-available/`
3. To disable a site, the symlink in `sites-enabled/` is removed (the original config in `sites-available/` is preserved)
4. Nginx only loads configurations from `sites-enabled/`

This pattern allows you to:
- Keep all configurations available for quick enabling/disabling
- Disable sites without deleting their configurations
- Maintain a clean separation between available and active sites

---

## nginx.enable_site

Enable an Nginx site by creating a symlink from sites-available to sites-enabled.

### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `site_name` | string | Yes | The site configuration file name (without path) |

### Response Format

#### Success Response

```json
{
  "success": true,
  "data": {
    "site_name": "example.com",
    "available_path": "/etc/nginx/sites-available/example.com",
    "enabled_path": "/etc/nginx/sites-enabled/example.com",
    "enabled": true
  }
}
```

#### Already Enabled Response

If the site is already enabled (symlink exists and points to the correct location):

```json
{
  "success": true,
  "data": {
    "site_name": "example.com",
    "enabled": true,
    "already_enabled": true
  }
}
```

### Example Request

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "command": "nginx.enable_site",
  "params": {
    "site_name": "example.com"
  },
  "timestamp": 1234567890
}
```

### Example Response

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "success": true,
  "data": {
    "site_name": "example.com",
    "available_path": "/etc/nginx/sites-available/example.com",
    "enabled_path": "/etc/nginx/sites-enabled/example.com",
    "enabled": true
  }
}
```

### Error Cases

| Error Code | Description |
|------------|-------------|
| `SITE_NOT_FOUND` | The site configuration does not exist in sites-available |
| `FILE_EXISTS` | A regular file (not a symlink) already exists at the enabled path |
| `VALIDATION_ERROR` | The site name failed validation (invalid characters, path traversal, etc.) |
| `EXECUTION_FAILED` | Failed to create the symlink (permissions, disk error, etc.) |

#### Example Error Response

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "success": false,
  "error": {
    "code": "SITE_NOT_FOUND",
    "message": "Site configuration not found: /etc/nginx/sites-available/nonexistent.com"
  }
}
```

### Behavior Notes

1. The command first verifies the configuration exists in `/etc/nginx/sites-available/`
2. If a symlink already exists but points to a different target, it is replaced
3. The `sites-enabled` directory is created if it does not exist
4. If the site is already properly enabled, the command succeeds with `already_enabled: true`

---

## nginx.disable_site

Disable an Nginx site by removing the symlink from sites-enabled.

### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `site_name` | string | Yes | The site configuration file name (without path) |

### Response Format

#### Success Response

```json
{
  "success": true,
  "data": {
    "site_name": "example.com",
    "enabled_path": "/etc/nginx/sites-enabled/example.com",
    "disabled": true
  }
}
```

#### Already Disabled Response

If the site is already disabled (symlink does not exist):

```json
{
  "success": true,
  "data": {
    "site_name": "example.com",
    "disabled": true,
    "already_disabled": true
  }
}
```

### Example Request

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440001",
  "command": "nginx.disable_site",
  "params": {
    "site_name": "example.com"
  },
  "timestamp": 1234567890
}
```

### Example Response

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440001",
  "success": true,
  "data": {
    "site_name": "example.com",
    "enabled_path": "/etc/nginx/sites-enabled/example.com",
    "disabled": true
  }
}
```

### Error Cases

| Error Code | Description |
|------------|-------------|
| `NOT_A_SYMLINK` | The path exists but is a regular file, not a symlink (safety protection) |
| `VALIDATION_ERROR` | The site name failed validation (invalid characters, path traversal, etc.) |
| `EXECUTION_FAILED` | Failed to remove the symlink (permissions, etc.) |

#### Example Error Response

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440001",
  "success": false,
  "error": {
    "code": "NOT_A_SYMLINK",
    "message": "Path /etc/nginx/sites-enabled/example.com is not a symlink. Refusing to delete for safety."
  }
}
```

### Behavior Notes

1. If the symlink does not exist, the command succeeds with `already_disabled: true`
2. For safety, the command refuses to delete regular files - only symlinks are removed
3. The original configuration in `sites-available/` is preserved
4. A configuration reload is required for changes to take effect (not handled by this command)

---

## nginx.test_config

Test the Nginx configuration for syntax errors by running `nginx -t`.

### Parameters

None required.

### Response Format

#### Success Response (Valid Configuration)

```json
{
  "success": true,
  "data": {
    "valid": true,
    "output": "nginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful"
  }
}
```

### Example Request

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440002",
  "command": "nginx.test_config",
  "params": {},
  "timestamp": 1234567890
}
```

### Example Response (Valid)

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440002",
  "success": true,
  "data": {
    "valid": true,
    "output": "nginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful"
  }
}
```

### Example Response (Invalid)

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440002",
  "success": false,
  "error": {
    "code": "CONFIG_INVALID",
    "message": "Nginx configuration test failed:\nnginx: [emerg] unknown directive \"invalid_directive\" in /etc/nginx/sites-enabled/example.com:10\nnginx: configuration file /etc/nginx/nginx.conf test failed"
  }
}
```

### Error Cases

| Error Code | Description |
|------------|-------------|
| `CONFIG_INVALID` | The Nginx configuration contains syntax errors |
| `EXECUTION_FAILED` | Failed to execute `nginx -t` (nginx not installed, permissions, timeout) |

### Behavior Notes

1. Executes `nginx -t` with a 30-second timeout
2. The output is captured from stderr (nginx -t writes to stderr)
3. This command only tests the configuration - it does not reload Nginx
4. Tests all included configurations (main nginx.conf and all enabled sites)

---

## Nginx Config Testing Before Enable

**Important**: The `nginx.enable_site` command does NOT automatically test the configuration before enabling a site. To ensure safe deployments, clients should:

1. Enable the site with `nginx.enable_site`
2. Test the configuration with `nginx.test_config`
3. If the test fails, disable the site with `nginx.disable_site`
4. Only reload Nginx if the configuration test passes

### Recommended Workflow

```
1. nginx.enable_site  -> Enable the site configuration
2. nginx.test_config  -> Verify the configuration is valid
3. If valid:
   - systemd.reload_unit (nginx.service)  -> Apply the changes
4. If invalid:
   - nginx.disable_site  -> Rollback the change
   - Report the error to the user
```

---

## Auto-Reload Behavior

**Important**: None of the Nginx commands automatically reload the Nginx service. After enabling or disabling sites, you must explicitly reload Nginx for changes to take effect.

### Why No Auto-Reload?

1. **Atomic Operations**: Multiple site changes can be batched before a single reload
2. **Safety**: Configuration can be tested before reload
3. **Control**: Operators maintain explicit control over when changes are applied
4. **Error Handling**: Clients can implement their own rollback strategies

### Reloading Nginx

To apply configuration changes after enabling/disabling sites, use the systemd commands:

```json
{
  "command": "systemd.reload_unit",
  "params": {
    "unit_name": "nginx.service"
  }
}
```

Or restart if a reload is not sufficient:

```json
{
  "command": "systemd.restart_unit",
  "params": {
    "unit_name": "nginx.service"
  }
}
```

---

## Security Considerations

### Path Traversal Protection

All site name inputs are validated to prevent path traversal attacks:

- Sequences like `../` are rejected
- Slashes are not allowed in site names
- Names must start with alphanumeric characters

### Symlink Safety

- `nginx.enable_site` only creates symlinks, never overwrites regular files
- `nginx.disable_site` only removes symlinks, refuses to delete regular files
- This prevents accidental deletion of configuration files

### Privilege Requirements

These commands require appropriate permissions to:
- Read from `/etc/nginx/sites-available/`
- Create/remove symlinks in `/etc/nginx/sites-enabled/`
- Execute `nginx -t` for configuration testing
