# Package Commands

Package commands provide system package management capabilities via `apt-get`. All package operations are protected by a whitelist system that restricts which packages can be installed, removed, or which repositories can be added.

## Commands Overview

| Command | Description |
|---------|-------------|
| `package.install` | Install whitelisted packages |
| `package.remove` | Remove packages |
| `package.update` | Update package lists |
| `package.add_repository` | Add whitelisted PPA repositories |

---

## package.install

Installs one or more whitelisted packages via `apt-get install`.

### Description

This command installs packages using `apt-get` with security-focused flags:
- Non-interactive mode (`-y`)
- Minimal install without recommends (`--no-install-recommends`)
- Preserves existing configuration files (`--force-confdef`, `--force-confold`)
- Sets `DEBIAN_FRONTEND=noninteractive`

### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `packages` | string[] | Yes | Array of package names to install (max 20) |

### Response Format

```json
{
  "success": true,
  "data": {
    "packages": ["nginx", "redis-server"],
    "action": "install",
    "stdout": "... apt-get output ..."
  }
}
```

### Example Request

```json
{
  "id": "req-123",
  "command": "package.install",
  "params": {
    "packages": ["nginx", "redis-server", "php8.3-fpm"]
  },
  "timestamp": 1704067200,
  "nonce": "abc123",
  "signature": "..."
}
```

### Example Response

```json
{
  "id": "req-123",
  "success": true,
  "data": {
    "packages": ["nginx", "redis-server", "php8.3-fpm"],
    "action": "install",
    "stdout": "Reading package lists...\nBuilding dependency tree...\n..."
  }
}
```

### Error Cases

| Error | Cause |
|-------|-------|
| `PackageNotWhitelisted` | One or more packages are not in the allowed whitelist |
| `InvalidParameter` | Package list is empty, exceeds 20 packages, or contains invalid characters |
| `ExecutionFailed` | `apt-get install` command failed |

### Timeout

10 minutes (600 seconds)

---

## package.remove

Removes one or more packages via `apt-get remove` or `apt-get purge`.

### Description

This command removes packages from the system. Optionally, it can purge packages to also remove configuration files.

### Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `packages` | string[] | Yes | - | Array of package names to remove (max 20) |
| `purge` | boolean | No | `false` | If true, use `purge` instead of `remove` to also delete config files |

### Response Format

```json
{
  "success": true,
  "data": {
    "packages": ["nginx"],
    "action": "remove",
    "purge": false,
    "stdout": "... apt-get output ..."
  }
}
```

### Example Request

```json
{
  "id": "req-456",
  "command": "package.remove",
  "params": {
    "packages": ["nginx"],
    "purge": true
  },
  "timestamp": 1704067200,
  "nonce": "def456",
  "signature": "..."
}
```

### Example Response

```json
{
  "id": "req-456",
  "success": true,
  "data": {
    "packages": ["nginx"],
    "action": "purge",
    "purge": true,
    "stdout": "Reading package lists...\nRemoving nginx...\n..."
  }
}
```

### Error Cases

| Error | Cause |
|-------|-------|
| `PackageNotWhitelisted` | One or more packages are not in the allowed whitelist |
| `InvalidParameter` | Package list is empty, exceeds 20 packages, or contains invalid characters |
| `ExecutionFailed` | `apt-get remove/purge` command failed |

### Timeout

5 minutes (300 seconds)

---

## package.update

Updates the package lists via `apt-get update`.

### Description

This command refreshes the package index files from their sources. This should typically be run before installing new packages to ensure you get the latest available versions.

### Parameters

None required.

### Response Format

```json
{
  "success": true,
  "data": {
    "action": "update",
    "stdout": "... apt-get output ..."
  }
}
```

### Example Request

```json
{
  "id": "req-789",
  "command": "package.update",
  "params": {},
  "timestamp": 1704067200,
  "nonce": "ghi789",
  "signature": "..."
}
```

### Example Response

```json
{
  "id": "req-789",
  "success": true,
  "data": {
    "action": "update",
    "stdout": "Hit:1 http://archive.ubuntu.com/ubuntu focal InRelease\nGet:2 http://archive.ubuntu.com/ubuntu focal-updates InRelease\n..."
  }
}
```

### Error Cases

| Error | Cause |
|-------|-------|
| `ExecutionFailed` | `apt-get update` command failed |

### Timeout

5 minutes (300 seconds)

---

## package.add_repository

Adds a whitelisted PPA repository via `add-apt-repository`.

### Description

This command adds a PPA (Personal Package Archive) repository to the system's apt sources. Only whitelisted PPAs can be added for security reasons.

### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `repository` | string | Yes | PPA repository in `ppa:owner/name` format |

### Response Format

```json
{
  "success": true,
  "data": {
    "repository": "ppa:ondrej/php",
    "action": "add",
    "stdout": "... add-apt-repository output ..."
  }
}
```

### Example Request

```json
{
  "id": "req-012",
  "command": "package.add_repository",
  "params": {
    "repository": "ppa:ondrej/php"
  },
  "timestamp": 1704067200,
  "nonce": "jkl012",
  "signature": "..."
}
```

### Example Response

```json
{
  "id": "req-012",
  "success": true,
  "data": {
    "repository": "ppa:ondrej/php",
    "action": "add",
    "stdout": "PPA added successfully...\n..."
  }
}
```

### Error Cases

| Error | Cause |
|-------|-------|
| `RepositoryNotWhitelisted` | Repository is not in the allowed whitelist |
| `InvalidParameter` | Repository is empty, not in `ppa:owner/name` format, or contains dangerous characters |
| `ExecutionFailed` | `add-apt-repository` command failed |

### Timeout

5 minutes (300 seconds)

---

## Package Whitelist System

The daemon enforces a strict whitelist system for package operations to prevent installation of unauthorized or potentially dangerous software.

### Security Model

1. **Default Deny**: Only explicitly whitelisted packages and repositories are allowed
2. **No Dangerous Characters**: Package names are validated against shell metacharacters
3. **Version Specifiers Allowed**: You can specify versions like `nginx=1.18.0-0ubuntu1`
4. **Maximum List Size**: Package lists are limited to 20 items per request

### Validation Rules

Package names are rejected if they contain:
- Path traversal sequences (`..`)
- Forward slashes (`/`)
- Newlines (`\n`)
- Semicolons (`;`)

Repository strings are rejected if they contain any shell metacharacters:
- `;`, `|`, `&`, `$`, `` ` ``, `(`, `)`, `{`, `}`, `[`, `]`
- `<`, `>`, `\n`, `\r`, `\`, `"`, `'`, `*`, `?`, `!`

---

## Allowed Packages List

### Static Packages (Non-PHP)

#### Web Servers
- `nginx`
- `nginx-extras`
- `nginx-full`

#### Cache Systems
- `redis-server`
- `redis-tools`
- `memcached`
- `libmemcached-tools`

#### Databases
- `postgresql`
- `postgresql-client`
- `postgresql-14`
- `postgresql-15`
- `postgresql-16`
- `postgresql-17`
- `mariadb-server`
- `mariadb-client`
- `mysql-server`
- `mysql-client`

#### Process Managers
- `supervisor`

#### Node.js
- `nodejs`
- `npm`

#### SSL/Certificates
- `certbot`
- `python3-certbot-nginx`

#### Common Utilities
- `git`
- `unzip`
- `zip`
- `curl`
- `wget`

### PHP Packages

PHP packages are dynamically generated based on allowed versions and extensions.

#### Allowed PHP Versions
- `8.1`
- `8.2`
- `8.3`
- `8.4`

#### Allowed PHP Extensions
| Extension | Description |
|-----------|-------------|
| `fpm` | FastCGI Process Manager |
| `cli` | Command-line interface |
| `common` | Common files |
| `mysql` | MySQL driver |
| `pgsql` | PostgreSQL driver |
| `sqlite3` | SQLite3 driver |
| `redis` | Redis extension |
| `memcached` | Memcached extension |
| `mongodb` | MongoDB driver |
| `curl` | cURL extension |
| `gd` | GD graphics library |
| `imagick` | ImageMagick extension |
| `intl` | Internationalization |
| `mbstring` | Multibyte string |
| `xml` | XML support |
| `zip` | ZIP archive support |
| `bcmath` | BCMath arbitrary precision |
| `soap` | SOAP support |
| `opcache` | OPcache optimizer |
| `readline` | Readline support |
| `ldap` | LDAP support |
| `imap` | IMAP support |
| `gmp` | GMP support |
| `xdebug` | Xdebug debugger |
| `dev` | Development files |
| `apcu` | APCu cache |
| `igbinary` | Igbinary serializer |
| `msgpack` | MessagePack serializer |

#### PHP Package Naming

PHP packages follow the format `php{version}-{extension}`. Examples:
- `php8.3-fpm`
- `php8.2-mysql`
- `php8.4-redis`

---

## Allowed PPA Repositories

The following PPA repositories are allowed by default:

| Repository | Description |
|------------|-------------|
| `ppa:ondrej/php` | PHP packages (Ondrej Sury) |
| `ppa:ondrej/nginx` | Nginx stable |
| `ppa:ondrej/nginx-mainline` | Nginx mainline |
| `ppa:redislabs/redis` | Redis packages |
| `ppa:certbot/certbot` | Certbot/Let's Encrypt |
| `ppa:git-core/ppa` | Latest Git |

---

## Extending Whitelists via Configuration

The whitelist system can be extended through the daemon configuration file without modifying source code. Additional items are *added* to the built-in defaults, not replacements.

### Configuration Structure

In your daemon configuration file (TOML format):

```toml
[whitelists]
# Additional packages beyond built-in defaults
additional_packages = [
    "custom-package",
    "another-package"
]

# Additional PHP versions beyond 8.1-8.4
additional_php_versions = [
    "8.5",
    "7.4"
]

# Additional PHP extensions beyond built-in defaults
additional_php_extensions = [
    "custom-ext",
    "another-ext"
]

# Additional PPA repositories beyond built-in defaults
additional_repositories = [
    "ppa:custom/repo",
    "ppa:another/ppa"
]

# Additional allowed services (for service commands)
additional_services = [
    "custom-service"
]

# Additional path prefixes for file operations
additional_path_prefixes = [
    "/custom/path/"
]
```

### Configuration Options

| Option | Type | Description |
|--------|------|-------------|
| `additional_packages` | string[] | Extra package names to allow |
| `additional_php_versions` | string[] | Extra PHP versions (e.g., "8.5", "7.4") |
| `additional_php_extensions` | string[] | Extra PHP extension names |
| `additional_repositories` | string[] | Extra PPA repositories in `ppa:owner/name` format |
| `additional_services` | string[] | Extra systemd service names |
| `additional_path_prefixes` | string[] | Extra path prefixes for file operations |

### Example: Adding Custom PHP Configuration

To allow PHP 8.5 with a custom extension:

```toml
[whitelists]
additional_php_versions = ["8.5"]
additional_php_extensions = ["custom-ext"]
```

This would allow packages like:
- `php8.5-fpm`
- `php8.5-cli`
- `php8.3-custom-ext`
- `php8.5-custom-ext`

### Example: Adding a Custom PPA

To allow a custom PPA repository:

```toml
[whitelists]
additional_repositories = ["ppa:myteam/custom-packages"]
additional_packages = ["my-custom-tool"]
```

### Initialization

Whitelists are initialized once at daemon startup via `init_whitelists()`. Changes to the configuration require a daemon restart to take effect.

---

## Error Reference

### ValidationErrorKind::PackageNotWhitelisted

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Package 'unknown-package' is not whitelisted"
  }
}
```

### ValidationErrorKind::RepositoryNotWhitelisted

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Repository 'ppa:unknown/repo' is not whitelisted"
  }
}
```

### ValidationErrorKind::InvalidParameter

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Package name contains invalid characters"
  }
}
```

### CommandErrorKind::ExecutionFailed

```json
{
  "success": false,
  "error": {
    "code": "EXECUTION_ERROR",
    "message": "apt-get install failed: E: Unable to locate package..."
  }
}
```
